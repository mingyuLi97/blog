# ç¬¬å…«ç« ï¼šæŒ‚è½½ä¸æ›´æ–°

## æŒ‚è½½å­èŠ‚ç‚¹å’Œå…ƒç´ çš„å±æ€§

1. éå† vnode ä¸Šçš„ props å®Œæˆå±æ€§çš„æŒ‚è½½
2. é€’å½’çš„å¤„ç† childrenï¼Œå®Œæˆå­èŠ‚ç‚¹çš„æŒ‚è½½

```javascript
const vnode = {
  type: 'div',
  props: {
    id: 'foo'
  },
  children: [
    {
      type: 'p',
      children: 'hello'
    }
  ]
};

function mountElement(vnode, container) {
  const el = document.createElement(vnode.type);

  if (vnode.props) {
    for (const k in vnode.props) {
      // ğŸ‘‡ ç­‰åŒ => el.setAttribute(k, vnode.props[k])
      el[k] = vnode.props[k];
    }
  }

  if (typeof vnode.children === 'string') {
    el.textContent = vnode.children;
  } else if (Array.isArray(vnode.children)) {
    vnode.children.forEach(child => {
      // å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡æŒ‚è½½ï¼Œæ—§èŠ‚ç‚¹ä»ç„¶ä¼ é€’ nullã€‚ æŒ‚è½½çš„å…ƒç´ æ˜¯æ–°åˆ›å»ºå‡ºæ¥çš„ el
      patch(null, child, el);
    });
  }

  container.appendChild(el);
}
```

## HTML Attributes å’Œ DOM Properties

HTML Attributesï¼š `<div id='foo'>`

DOM Propertiesï¼š

```javascript
const el = document.querySelector('#foo');
el.id = 'xxx';
```

:::tip
HTML Attributes çš„ä½œç”¨æ˜¯è®¾ç½®ä¸ä¹‹å¯¹åº”çš„ DOM Properties çš„åˆå§‹å€¼ã€‚å› æ­¤åé¢è®¾ç½®å€¼æ—¶åº”ä¼˜å…ˆä½¿ç”¨ DOM Propertiesã€‚
:::

```javascript
// ä¸€ä¸ª input æ ‡ç­¾ <input value="foo" />
const el = document.querySelector('input');
el.value; // foo
el.getAttribute('value'); // foo
// -------- å°† value ä¿®æ”¹ä¸º bar -------------
el.value; // bar
el.getAttribute('value'); // foo
el.defaultValue; // foo
```

## ä¸€äº›ç‰¹æ®Šå¤„ç†

æˆ‘ä»¬å†™ä¸¤ä¸ªç¦ç”¨æŒ‰é’®çš„ dom

```HTML
<button disable> buttonA </button>
<button :disable="false"> buttonB </button>
```

åœ¨ vue æ¨¡ç‰ˆç¼–è¯‘åè¾“å‡ºçš„ vnode

```javascript
const buttonA = {
  type: 'button',
  props: { disable: '' }
};

const buttonB = {
  type: 'button',
  props: { disable: false }
};
```

render æ—¶

```javascript
//  -------------- æ‰§è¡Œæ ‡ç­¾è®¾ç½® ---------------
el.setAttribute('disable', ''); // æ­£å¸¸
// è®¾ç½®å±æ€§æ—¶ï¼Œæ€»æ˜¯ä¼šè¢« stringifyï¼Œåœ¨ dom å¤„ç†æ—¶ï¼Œå†æŠŠ 'false' => trueï¼Œè¿™æ ·é€ æˆäº†é”™è¯¯
el.setAttribute('disable', 'false');

//  -------------- æ‰§è¡Œå±æ€§è®¾ç½® ---------------
el.disable = ''; // '' => falseï¼Œå¼•èµ·é”™è¯¯
el.disable = false; // æ­£å¸¸
```

å¯ä»¥å‘ç°ï¼Œæ— è®ºä½¿ç”¨å“ªç§æ–¹å¼éƒ½æœ‰å¯èƒ½å‡ºç°é—®é¢˜ï¼Œå¯¹äºè¿™ç§æƒ…å†µåªèƒ½åšç‰¹æ®Šå¤„ç†ã€‚

```javascript{10,11}
function mountElement(vnode, container) {
  const el = document.createElement(vnode.type);
  if (vnode.props) {
    for (const k in vnode.props) {
      // å±æ€§æ˜¯å¦å­˜åœ¨äº DOM Properties
      if (k in el) {
        // å–å‡ºæ•°æ®ç±»å‹æ–¹ä¾¿åé¢ç‰¹æ®Šå¤„ç†
        const type = typeof el[k];
        const value = vnode.props[k];
        // ç‰¹æ®Šå¤„ç†ï¼ˆbutton çš„ disableï¼‰
        if (type === 'boolean' && value === '') {
          el[k] = true;
        } else {
          el[k] = value;
        }
      } else {
        el.setAttribute(k, vnode.props[k]);
      }
    }
  }
  /** ... */
}
```

æœ‰ä¸€äº›å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½å¯¹å…¶ä¿®æ”¹ï¼Œä¹Ÿéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚

```html
<form id="form1"></form>
<input form="form1" />
```

```javascript
function shouldSetAsProps(el, key, val) {
  // ç‰¹æ®Šå¤„ç†
  if (key === 'form' && el.tagName === 'INPUT') return false;
  // å…œåº•
  return key in el;
}

function mountElement(vnode, container) {
  const el = document.createElement(vnode.type);
  if (vnode.props) {
    for (const k in vnode.props) {
      // å±æ€§æ˜¯å¦å­˜åœ¨äº DOM Properties
      if (shouldSetAsProps(el, k, vnode.props[k])) {
        /** ... */
      } else {
        el.setAttribute(k, vnode.props[k]);
      }
    }
  }
  /** ... */
}
```

## classã€style çš„ç‰¹æ®Šå¤„ç†ï¼ˆå¢å¼ºï¼‰

ä¸ºäº†æ–¹ä¾¿å¼€å‘ï¼Œåœ¨ Vue ä¸­ä½¿ç”¨ classã€style å¯ä»¥ä½¿ç”¨å¤šç§æ–¹å¼

```html
<!-- å­—ç¬¦ä¸² -->
<div class="foo bar"></div>
<!-- å¯¹è±¡ -->
<div :class="{foo: true}"></div>
<!-- æ•°ç»„ -->
<div :class="[{foo: true}, 'bar']"></div>
```

```javascript
const vnode = {
  type: 'div',
  props: {
    class: normalizeClass([{ foo: true }, 'bar']) // åºåˆ—åŒ–çš„ç»“æœ => 'foo bar'
  }
};
```

class æœ‰å¤šç§è®¾ç½®æ–¹å¼ï¼Œåœ¨è®¾ç½® 1000 æ¬¡æ—¶çš„æ€§èƒ½ï¼š `el.className` > `el.setAttribute` > `classList`, å› æ­¤ Vue ä¸­ä½¿ç”¨äº† className çš„æ–¹å¼

## å¸è½½æ“ä½œ

```javascript
function render(vnode, container) {
  if (vnode) {
    // æ–° vnode å­˜åœ¨ï¼Œå°†å…¶ä¸æ—§ vnode ä¸€èµ·ä¼ é€’ç»™ patch å‡½æ•°ï¼Œè¿›è¡Œæ‰“è¡¥ä¸
    patch(container._vnode, vnode, container);
  } else {
    if (container._vnode) {
      // æ—§ vnode å­˜åœ¨ï¼Œæ–°çš„ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯å¸è½½æ“ä½œ - unmount
      container.innerHTML = '';
    }
  }
  container._vnode = vnode;
}
```

åœ¨ä¹‹å‰æˆ‘ä»¬æ˜¯é€šè¿‡ `container.innerHTML = '';` çš„æ–¹å¼å®Œæˆç»„ä»¶å¸è½½ï¼Œä½†æ˜¯è¿™æ ·åšå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š

- å®¹å™¨æ‰§è¡Œå¸è½½æ—¶ï¼Œåº”è°ƒç”¨ç»„ä»¶å¯¹åº”çš„ `beforeUnmountã€unmounted` ç”Ÿå‘½å‘¨æœŸ
- æœ‰çš„å…ƒç´ å­˜åœ¨è‡ªå®šä¹‰æŒ‡ä»¤ï¼Œåº”è°ƒç”¨å¯¹åº”æŒ‡ä»¤çš„é’©å­å‡½æ•°
- innerHTML ä¸ä¼šç§»é™¤ç»‘å®šåœ¨ DOM ä¸Šçš„äº‹ä»¶

æ­£ç¡®çš„å¸è½½æ–¹å¼ï¼šæ ¹æ® vnode è·å–ä¸å…¶ç›¸å…³è”çš„çœŸå® DOMï¼Œé€šè¿‡åŸç”Ÿæ–¹æ³•å°†å…ƒç´ ç§»é™¤ã€‚

```javascript{3,21}
function mountElement(vnode, container) {
  const el = document.createElement(vnode.type);
  vnode.el = el; // å°†çœŸå® DOM æŒ‚è½½åˆ° vnode èŠ‚ç‚¹ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨
  /** ... */
}

function unmount(vnode){
  /** æœ‰äº†è™šæ‹ŸèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨æŒ‡ä»¤é’©å­å’Œç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸäº† */
  const parent = vnode.el.parentNode;
  if(parent){
    parent.removeChild(vnode.el)
  }
}

function render(vnode, container) {
  if (vnode) {
    // æ–° vnode å­˜åœ¨ï¼Œå°†å…¶ä¸æ—§ vnode ä¸€èµ·ä¼ é€’ç»™ patch å‡½æ•°ï¼Œè¿›è¡Œæ‰“è¡¥ä¸
    patch(container._vnode, vnode, container);
  } else {
    if (container._vnode) {
      unmount(container._vnode)
    }
  }
  container._vnode = vnode;
}
```

## äº‹ä»¶çš„å¤„ç†

åœ¨ç»‘å®šäº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬ç»‘å®šä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•° `invoker`ï¼Œç„¶åæŠŠçœŸæ­£äº‹ä»¶å¤„ç†çš„å‡½æ•°è®¾ç½®ä¸º `invoker.value`ï¼Œè¿™æ ·æ›´æ–°æ—¶å°±ä¸ç”¨è°ƒç”¨ `removeEventListener` æ¥ç§»é™¤ä¸Šæ¬¡ç»‘å®šçš„äº‹ä»¶ï¼Œåªéœ€è¦æ›´æ–° `invoker.value`çš„å€¼å³å¯ã€‚

veiï¼švue event invoker

```javascript
function patchProps(el, key, pervValue, nextValue) {
  if (/^on/.text(key)) {
    // å®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ç›‘å¬å¤šä¸ªäº‹ä»¶ï¼Œé˜²æ­¢è¢«è¦†ç›–
    const invokers = el._vei || (el._vei = {});
    let invoker = invokers[key];
    const name = key.slice(2).toLowerCase();
    if (nextValue) {
      if (!invoker) {
        invoker = el._vei[key] = e => {
          invoker.value(e);
        };
        invoker.value = nextValue;
        el.addEventListener(name, invoker);
      } else {
        invoker.value = nextValue;
      }
    } else if (invoker) {
      el.removeEventListener(name, invoker);
    }
  }
}
```
